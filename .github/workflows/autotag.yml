# L'objectif de ce fichier aura pour but de crÃ©er des tags automatiquement lors de pull request
# v"major"."feat"."patch"
# Exemple de titre de la PR
# major - Ajout d'une nouvelle thÃ©matique de cours
# feat - Ajout d'un nouveau header ou phrases
# fix - Correction d'orthographe

name: ðŸš€ Auto Tag & Release

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  auto-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # on veut tous les tags

      - name: Configure git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Get latest tag
        id: get_tag
        run: |
          latest_tag=$(git tag --sort=-v:refname | head -n 1)
          if [ -z "$latest_tag" ]; then
            latest_tag="v0.0.0"
          fi
          echo "latest_tag=$latest_tag" >> $GITHUB_ENV
          echo "Dernier tag dÃ©tectÃ© : $latest_tag"

      - name: Determine bump type
        id: bump
        run: |
          pr_title="${{ github.event.pull_request.title }}"
          pr_labels="${{ toJson(github.event.pull_request.labels) }}"
          bump="patch" # par dÃ©faut
      
          if [[ "$pr_title" =~ ^[Mm]ajor ]] || [[ "$pr_labels" == *"major"* ]]; then
            bump="major"
          elif [[ "$pr_title" =~ ^[Ff]eat ]] || [[ "$pr_labels" == *"feat"* ]]; then
            bump="minor"
          fi
      
          echo "bump=$bump" >> $GITHUB_ENV
          echo "ðŸ§© Type dâ€™incrÃ©ment dÃ©tectÃ© : $bump"

      - name: Compute next version
        id: next
        run: |
          version=${{ env.latest_tag }}
          version=${version#v}  # supprime le 'v' au dÃ©but
          IFS='.' read -r major feat patch <<< "$version"

          case "${{ env.bump }}" in
            major)
              major=$((major + 1))
              feat=0
              patch=0
              ;;
            feat)
              feat=$((feat + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          next_tag="v$major.$feat.$patch"
          echo "next_tag=$next_tag" >> $GITHUB_ENV
          echo "âœ¨ Nouveau tag : $next_tag"

      - name: Create and push tag
        run: |
          git tag ${{ env.next_tag }}
          git push origin ${{ env.next_tag }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.next_tag }}
          name: "ðŸš€ Release ${{ env.next_tag }}"
          body: |
            ### Changement fusionnÃ©
            **PR #${{ github.event.pull_request.number }}** â€” ${{ github.event.pull_request.title }}

            Auteur : @${{ github.actor }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
